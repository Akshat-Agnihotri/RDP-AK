name: AvicaRDP

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Download files
        run: |
          Invoke-WebRequest -Uri "https://download.avica.com/AvicaLite_v8.0.8.9.exe" -OutFile "Avica_setup.exe"
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/Akshat-Agnihotri/RDP-AK/refs/heads/main/.github/workflows/setup.py" -OutFile "setup.py"
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/Akshat-Agnihotri/RDP-AK/refs/heads/main/.github/workflows/loop.bat" -OutFile "loop.bat"

      - name: Setup System User
        run: net user runneradmin TheDisa1a

      - name: Install Python Dependencies
        run: python -m pip install requests telegraph

      - name: Enable RDP + Install Avica
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Start-Process Avica_setup.exe

      - name: Wait for Avica ID + Upload to GoFile
        run: python setup.py

      - name: Keep Session Active
        run: cmd /c loop.bat
